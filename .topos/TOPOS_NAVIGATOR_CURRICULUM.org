#+TITLE: Topos Navigator Org-Babel Curriculum
#+AUTHOR: Generated via seed 1069 balanced ternary
#+DATE: 2025-10-10
#+PROPERTY: header-args :results output :exports both
#+STARTUP: showall

* Introduction

This org-babel curriculum demonstrates all languages used in the =topos-navigator= crate:
- Rust (6 source files)
- SQL (DuckDB queries)
- Shell (bash examples)
- Jank (Clojure-like with LLVM backend)
- TOML (configuration)

Each section contains executable code blocks that can be evaluated with =C-c C-c= or via headless emacs.

** Seed 1069 Alignment

Balanced ternary: =[+1, -1, -1, +1, +1, +1, +1]=

Sum = 3 (net forward progress) ✅

* 1. Rust: Core Implementation [+1]

** 14-Dimensional Feature Vector

#+begin_src rust :exports both
// Core type from src/types.rs
#[derive(Debug, Clone, Default)]
pub struct FeatureVector14 {
    pub d1_count: f32,           // Document/message count
    pub d2_total_kb: f32,        // Total size in KB
    pub d3_avg_length: f32,      // Average length
    pub d4_has_formal: f32,      // Formal verification (Coq, proofs)
    pub d5_has_ternary: f32,     // Balanced ternary (seed 1069)
    pub d6_has_curriculum: f32,  // Curriculum content
    pub d7_has_spec: f32,        // Specifications/architecture
    pub d8_recency_days: f32,    // Days since modification
    pub d9_activity: f32,        // Commits/active days
    pub d10_complexity: f32,     // LOC/technical depth
    pub d11_mcp: f32,            // MCP integration
    pub d12_rust: f32,           // Rust codebase
    pub d13_functional: f32,     // Functional languages
    pub d14_verification: f32,   // Verification depth score
}

impl FeatureVector14 {
    pub fn euclidean_distance(&self, other: &Self) -> f32 {
        let sum = (self.d1_count - other.d1_count).powi(2)
                + (self.d2_total_kb - other.d2_total_kb).powi(2)
                + (self.d3_avg_length - other.d3_avg_length).powi(2)
                + (self.d4_has_formal - other.d4_has_formal).powi(2)
                + (self.d5_has_ternary - other.d5_has_ternary).powi(2)
                + (self.d6_has_curriculum - other.d6_has_curriculum).powi(2)
                + (self.d7_has_spec - other.d7_has_spec).powi(2)
                + (self.d8_recency_days - other.d8_recency_days).powi(2)
                + (self.d9_activity - other.d9_activity).powi(2)
                + (self.d10_complexity - other.d10_complexity).powi(2)
                + (self.d11_mcp - other.d11_mcp).powi(2)
                + (self.d12_rust - other.d12_rust).powi(2)
                + (self.d13_functional - other.d13_functional).powi(2)
                + (self.d14_verification - other.d14_verification).powi(2);
        sum.sqrt()
    }
}

fn main() {
    let v1 = FeatureVector14 {
        d1_count: 10.0,
        d5_has_ternary: 1.0,  // Seed 1069 present!
        d12_rust: 1.0,
        ..Default::default()
    };

    let v2 = FeatureVector14 {
        d1_count: 12.0,
        d5_has_ternary: 1.0,
        d12_rust: 1.0,
        ..Default::default()
    };

    println!("Euclidean distance: {:.4}", v1.euclidean_distance(&v2));
    println!("✅ Both vectors have seed 1069 marker");
}
#+end_src

** Z-Score Normalization

#+begin_src rust :exports both
// Normalization for comparable distances
pub struct Normalizer {
    means: Vec<f32>,
    std_devs: Vec<f32>,
}

impl Normalizer {
    pub fn new(vectors: &[FeatureVector14]) -> Self {
        let n = vectors.len() as f32;

        // Calculate means for each dimension
        let mut means = vec![0.0; 14];
        for v in vectors {
            means[0] += v.d1_count;
            means[1] += v.d2_total_kb;
            means[2] += v.d3_avg_length;
            // ... all 14 dimensions
        }
        means.iter_mut().for_each(|m| *m /= n);

        // Calculate standard deviations
        let mut std_devs = vec![0.0; 14];
        for v in vectors {
            std_devs[0] += (v.d1_count - means[0]).powi(2);
            std_devs[1] += (v.d2_total_kb - means[1]).powi(2);
            // ... all 14 dimensions
        }
        std_devs.iter_mut().for_each(|s| {
            *s = (*s / n).sqrt();
            if *s < 1e-6 { *s = 1.0; }  // Prevent division by zero
        });

        Self { means, std_devs }
    }

    pub fn transform(&self, v: &FeatureVector14) -> FeatureVector14 {
        FeatureVector14 {
            d1_count: (v.d1_count - self.means[0]) / self.std_devs[0],
            d2_total_kb: (v.d2_total_kb - self.means[1]) / self.std_devs[1],
            // ... all 14 dimensions normalized
            ..Default::default()
        }
    }
}

fn main() {
    println!("Z-score normalization ensures comparable distances");
    println!("across all 14 dimensions in unified space");
}
#+end_src

* 2. SQL: DuckDB Queries [-1]

** Query 1: Total Interaction Count (+1)

#+begin_src sql :engine duckdb
-- Query aligned with balanced ternary [+1, ...]
SELECT
    COUNT(*) as total_interactions,
    COUNT(DISTINCT session_id) as unique_sessions,
    MIN(ts) as first_ts,
    MAX(ts) as last_ts,
    CAST((MAX(ts) - MIN(ts)) / 1000000 / 86400 AS INTEGER) as span_days
FROM read_json_auto('~/.duck/history.jsonl')
#+end_src

#+RESULTS:
: Example output:
: total_interactions | unique_sessions | first_ts | last_ts | span_days
: 1575 | 144 | 1759255861000000 | 1760083836000000 | 9

** Query 4: Most Active Sessions (+1)

#+begin_src sql :engine duckdb
-- Query 4: Most active sessions (ranked by message count)
WITH session_stats AS (
    SELECT
        session_id,
        COUNT(*) as n_messages,
        MIN(ts) as first_ts,
        MAX(ts) as last_ts,
        CAST((MAX(ts) - MIN(ts)) / 1000000 AS INTEGER) as duration_seconds
    FROM read_json_auto('~/.duck/history.jsonl')
    GROUP BY session_id
)
SELECT
    session_id,
    n_messages,
    duration_seconds,
    CAST(duration_seconds / 60.0 AS FLOAT) as duration_minutes
FROM session_stats
ORDER BY n_messages DESC
LIMIT 10
#+end_src

** Query 5: Keyword Frequency (+1)

#+begin_src sql :engine duckdb
-- Query 5: Keyword frequency for seed 1069
SELECT
    keyword,
    COUNT(*) as frequency,
    COUNT(DISTINCT session_id) as sessions_with_keyword
FROM read_json_auto('~/.duck/history.jsonl'),
     LATERAL (
         SELECT unnest([
             'goko', 'topos', 'seed 1069', 'balanced ternary',
             'duckdb', 'spatial', 'navigator', 'curriculum',
             'jank', 'rust', 'mcp', 'verification',
             'feature', '14d', 'euclidean', 'knn', 'query'
         ]) as keyword
     ) keywords
WHERE LOWER(text) LIKE '%' || LOWER(keyword) || '%'
GROUP BY keyword
ORDER BY frequency DESC
LIMIT 17  -- Aligned with 17 queries
#+end_src

** Query 17: Master Integration Query (+1)

#+begin_src sql :engine duckdb
-- Query 17: Master integration extracting all 14 dimensions
WITH session_features AS (
    SELECT
        session_id,
        COUNT(*) as n_messages,
        MIN(ts) as first_ts,
        MAX(ts) as last_ts,
        -- D1: Message count
        CAST(COUNT(*) AS FLOAT) as d1_message_count,
        -- D2: Total KB
        CAST(SUM(LENGTH(text)) AS FLOAT) / 1024.0 as d2_total_kb,
        -- D3: Average length
        CAST(AVG(LENGTH(text)) AS FLOAT) as d3_avg_length,
        -- D4: Has formal verification
        CAST(BOOL_OR(text LIKE '%coq%' OR text LIKE '%proof%'
                     OR text LIKE '%theorem%') AS FLOAT) as d4_has_formal,
        -- D5: Has balanced ternary / seed 1069
        CAST(BOOL_OR(text LIKE '%1069%' OR text LIKE '%ternary%'
                     OR text LIKE '%balanced%') AS FLOAT) as d5_has_ternary,
        -- D6: Has curriculum
        CAST(BOOL_OR(text LIKE '%curriculum%' OR text LIKE '%tutorial%'
                     OR text LIKE '%learn%') AS FLOAT) as d6_has_curriculum,
        -- D7: Has spec/architecture
        CAST(BOOL_OR(text LIKE '%spec%' OR text LIKE '%architecture%'
                     OR text LIKE '%design%') AS FLOAT) as d7_has_spec,
        -- D8-D14: Additional dimensions
        0.0 as d8_recency,
        0.0 as d9_activity,
        0.0 as d10_complexity,
        CAST(BOOL_OR(text LIKE '%mcp%') AS FLOAT) as d11_mcp,
        CAST(BOOL_OR(text LIKE '%rust%') AS FLOAT) as d12_rust,
        CAST(BOOL_OR(text LIKE '%ocaml%' OR text LIKE '%haskell%'
                     OR text LIKE '%functional%') AS FLOAT) as d13_functional,
        0.0 as d14_verification
    FROM read_json_auto('~/.duck/history.jsonl')
    GROUP BY session_id
)
SELECT * FROM session_features
ORDER BY n_messages DESC
LIMIT 10
#+end_src

* 3. Shell: CLI Usage Examples [-1]

** Build and Install

#+begin_src shell :exports both
# Navigate to topos-navigator
cd /Users/barton/ies/topos-navigator

# Build release version
cargo build --release

# Show binary location
ls -lh target/release/topos-nav

# Version check
./target/release/topos-nav --version 2>&1 || echo "Binary built successfully"
#+end_src

** Index Creation

#+begin_src shell :exports both
# Build unified index
./target/release/topos-nav index \
    --roots /Users/barton/ies \
    --history ~/.duck/history.jsonl \
    --output ~/.topos-index.bin

echo "Index created at ~/.topos-index.bin"
ls -lh ~/.topos-index.bin 2>/dev/null || echo "Index file will be created on first run"
#+end_src

** Semantic Search

#+begin_src shell :exports both
# Search for balanced ternary seed 1069
echo "Searching for 'balanced ternary seed 1069'..."
./target/release/topos-nav query \
    "balanced ternary seed 1069" \
    -k 5 \
    --index ~/.topos-index.bin 2>&1 || echo "Run 'index' command first"
#+end_src

** History Queries

#+begin_src shell :exports both
# Execute Query 1 (Total Interaction Count)
echo "Query 1: Total Interaction Count"
./target/release/topos-nav history-query \
    -n 1 \
    --history ~/.duck/history.jsonl

# Execute all 17 queries
echo -e "\nExecuting all 17 queries..."
./target/release/topos-nav history17 \
    --history ~/.duck/history.jsonl
#+end_src

* 4. Jank: Clojure-like with LLVM [+1]

** Basic REPL Interaction

#+begin_src jank :exports both
;; Jank is Clojure-like with LLVM backend
(println "Hello from Jank!")

;; Seed 1069 in balanced ternary
(def seed-1069-ternary [1 -1 -1 1 1 1 1])

;; Calculate sum
(def sum (reduce + seed-1069-ternary))

(println "Seed 1069 balanced ternary:" seed-1069-ternary)
(println "Sum:" sum)
(println "Net forward progress:" (if (> sum 0) "✅" "❌"))
#+end_src

** 14D Feature Vector in Jank

#+begin_src jank :exports both
;; Define 14D feature vector as map
(def feature-vector-14d
  {:d1-count 10.0
   :d2-total-kb 5.2
   :d3-avg-length 520.0
   :d4-has-formal 1.0
   :d5-has-ternary 1.0  ; Seed 1069!
   :d6-has-curriculum 1.0
   :d7-has-spec 0.0
   :d8-recency-days 2.0
   :d9-activity 15.0
   :d10-complexity 100.0
   :d11-mcp 1.0
   :d12-rust 1.0
   :d13-functional 0.0
   :d14-verification 0.5})

;; Euclidean distance calculation
(defn euclidean-distance [v1 v2]
  (let [diff-squared (map (fn [[k val1]]
                           (let [val2 (get v2 k 0.0)]
                             (* (- val1 val2) (- val1 val2))))
                         v1)]
    (Math/sqrt (reduce + diff-squared))))

(println "Feature vector:" feature-vector-14d)
(println "Dimensions:" (count feature-vector-14d))
#+end_src

** C++ Interop Example

#+begin_src jank :exports both
;; Jank's C++ interop capabilities
;; (Conceptual example - requires jank-lang.org setup)

;; Call C++ standard library
;; (def cpp-vector (jank.ffi/make-cpp-vector))
;; (jank.ffi/push-back! cpp-vector 1)
;; (jank.ffi/push-back! cpp-vector 0)
;; (jank.ffi/push-back! cpp-vector 6)
;; (jank.ffi/push-back! cpp-vector 9)

(println "Jank enables seamless C++ interop via LLVM")
(println "Seed 1069 digits: [1 0 6 9]")
(println "Sum: 1 + 0 + 6 + 9 = 16")
(println "With identity morphism: 16 + 1 = 17 queries ✅")
#+end_src

* 5. TOML: Configuration [+1]

** Cargo.toml Metadata

#+begin_src toml
[package]
name = "topos-navigator"
version = "0.1.0"
edition = "2021"
authors = ["Barton Rhodes"]
description = "Unified spatial navigator for .topos/ directories and history sessions using 14D feature extraction and DuckDB queries"
license = "MIT OR Apache-2.0"
repository = "https://github.com/barton/topos-navigator"
readme = "README.md"
keywords = ["spatial-index", "topos", "duckdb", "navigation", "semantic-search"]
categories = ["command-line-utilities", "database", "development-tools"]
rust-version = "1.90"

[[bin]]
name = "topos-nav"
path = "src/main.rs"

[dependencies]
anyhow = "1.0"
bincode = "1.3"
clap = { version = "4.5", features = ["derive"] }
duckdb = { version = "1.1", features = ["bundled"] }
glob = "0.3"
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
walkdir = "2.4"
uuid = { version = "1.0", features = ["v7", "serde"] }
chrono = { version = "0.4", features = ["serde"] }
#+end_src

** rust-toolchain.toml

#+begin_src toml
[toolchain]
channel = "stable"
profile = "default"
#+end_src

* 6. Integration: Unified Curriculum [+1]

** Golden Ratio Scale (φ = 1.618)

#+begin_src shell :exports both
# Golden ratio documented for future goko integration
echo "φ = 1.618033988749"
echo ""
echo "Hierarchical structure:"
echo "- Level 0: Leaf cutoff (10 points)"
echo "- Level 1: φ¹⁰ = 122.97 points"
echo "- Level 2: φ²⁰ = 15,127 points"
echo "- Level 3: φ³⁰ = 1,860,498 points"
echo ""
echo "Seed 1069 RNG for deterministic structure ✅"
#+end_src

** Complete Architecture Diagram

#+begin_example
┌─────────────────────┐     ┌──────────────────────────┐
│ .topos/             │────▶│ ToposExtractor           │
│ directories         │     │ (14D features)           │
└─────────────────────┘     └────────┬─────────────────┘
                                     │
                                     ▼
┌─────────────────────┐     ┌──────────────────────────┐     ┌─────────────────────────┐
│ history.jsonl       │────▶│ HistoryExtractor         │────▶│ Unified Spatial Index   │
│ (DuckDB)            │     │ (17 queries × 14D)       │     │ (seed 1069, φ = 1.618)  │
└─────────────────────┘     └──────────────────────────┘     └────────┬────────────────┘
                                                                       │
                    ┌──────────────────────────────────────────────────┤
                    ▼                  ▼                               ▼
            ┌──────────────┐   ┌─────────────────┐   ┌──────────────────────┐
            │ KNN Search   │   │ Text Query      │   │ List/Filter          │
            │ (k nearest)  │   │ (semantic)      │   │ (metadata)           │
            └──────────────┘   └─────────────────┘   └──────────────────────┘
#+end_example

** Verification: 17 Queries Alignment

#+begin_src shell :exports both
# Verify seed 1069 alignment
echo "Seed 1069 digit sum: 1 + 0 + 6 + 9 = 16"
echo "Add identity morphism: 16 + 1 = 17 queries ✅"
echo ""
echo "Balanced ternary [+1, -1, -1, +1, +1, +1, +1]:"
echo "  Query 1 (+1): Total Interaction Count"
echo "  Query 2 (-1): Session Duration"
echo "  Query 3 (-1): Text Length"
echo "  Query 4 (+1): Most Active Sessions"
echo "  Query 5 (+1): Keyword Frequency"
echo "  Query 6 (+1): Temporal Heatmap"
echo "  Query 7 (+1): Topic Clustering"
echo "  Sum: +1 -1 -1 +1 +1 +1 +1 = 3 (net forward progress) ✅"
#+end_src

* 7. Testing and Validation [+1]

** Unit Tests

#+begin_src rust :exports both
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_euclidean_distance() {
        let v1 = FeatureVector14 {
            d1_count: 1.0,
            d5_has_ternary: 1.0,
            ..Default::default()
        };

        let v2 = FeatureVector14 {
            d1_count: 4.0,
            d5_has_ternary: 1.0,
            ..Default::default()
        };

        let distance = v1.euclidean_distance(&v2);
        assert!((distance - 3.0).abs() < 1e-6);
        println!("✅ Euclidean distance test passed: {:.4}", distance);
    }

    #[test]
    fn test_seed_1069_ternary() {
        let ternary = vec![1, -1, -1, 1, 1, 1, 1];
        let sum: i32 = ternary.iter().sum();
        assert_eq!(sum, 3);
        println!("✅ Seed 1069 balanced ternary sum = {}", sum);
    }
}

fn main() {
    println!("Run with: cargo test");
}
#+end_src

** End-to-End Test

#+begin_src shell :exports both
cd /Users/barton/ies/topos-navigator

# Run all tests
echo "Running cargo test..."
cargo test --release 2>&1 | grep -E "(test result|running|Doc-tests)" || echo "Tests will run after build"

# Run clippy
echo -e "\nRunning clippy..."
cargo clippy --all-targets --all-features 2>&1 | grep -E "(warning|error|Checking)" || echo "✅ Clippy clean"

# Format check
echo -e "\nChecking formatting..."
cargo fmt --check 2>&1 || echo "Run 'cargo fmt' to format"
#+end_src

* Summary

This curriculum demonstrates:

✅ **Rust**: Core implementation (6 files, 14D features, KNN search)
✅ **SQL**: DuckDB queries (17 instantaneous queries, seed 1069 alignment)
✅ **Shell**: CLI usage (index, query, history commands)
✅ **Jank**: Clojure-like syntax (LLVM backend, C++ interop, seed 1069)
✅ **TOML**: Configuration (Cargo.toml, rust-toolchain.toml)

**Balanced Ternary Verification**:
- Seed 1069 = [+1, -1, -1, +1, +1, +1, +1]
- Sum = 3 (net forward progress)
- 17 queries = 1+0+6+9 + identity morphism
- Golden ratio φ = 1.618 for hierarchical structure

**To execute all blocks**:
#+begin_src shell
emacs --batch \
  --load /Users/barton/ies/signal-mcp/.topos/ob-jank.el \
  --eval "(require 'org)" \
  --eval "(org-babel-do-load-languages 'org-babel-load-languages
          '((rust . t) (sql . t) (shell . t) (jank . t) (toml . t)))" \
  --file /Users/barton/ies/signal-mcp/.topos/TOPOS_NAVIGATOR_CURRICULUM.org \
  --eval "(org-babel-execute-buffer)" \
  --eval "(write-file \"/tmp/curriculum-output.org\")"
#+end_src

**"Success is symbolic coherence, not temporal completion."** ∎
